<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizare Comandă - Cleaning Shop</title>
    <link rel="stylesheet" href="/navbar.css">
    <link rel="stylesheet" href="/topbar.css">
    <link rel="stylesheet" href="/style.css">
    <style>
        .checkout-page { padding-top: 150px; display: flex; justify-content: center; padding-bottom: 50px; }
        .checkout-container { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 90%; max-width: 500px; }
        .checkout-container form { display: flex; flex-direction: column; gap: 15px; }
        .checkout-container input, .checkout-container textarea { padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-family: 'Montserrat', sans-serif; }
        #sumar-comanda { margin: 15px 0; padding: 15px; background: #f9fbff; border-radius: 10px; border: 1px solid #e0e8f0; }
        .checkout-btn { background: #102a43; color: white; border: none; padding: 1rem; border-radius: 50px; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .checkout-btn:hover { background: #00a8ff; }
    </style>
</head>
<body>

<main class="checkout-page">
    <div class="checkout-container">
        <h2>Finalizare Comandă</h2>
        <div id="sumar-comanda-final"></div>
        <form id="checkout-form-final">
            <input type="text" id="c-nume" placeholder="Nume Complet" required>
            <input type="email" id="c-email" placeholder="Email" required>
            <input type="tel" id="c-telefon" placeholder="Telefon" required>
            <textarea id="c-adresa" placeholder="Adresa de livrare" required></textarea>
            <button type="submit" class="checkout-btn">Trimite Comanda</button>
        </form>
    </div>
</main>

<script type="module" src="/supabase-config.js"></script>
<script type="module" src="/componente.js"></script>

<script type="module">
    document.addEventListener('DOMContentLoaded', () => {
        const sumar = document.getElementById('sumar-comanda-final');
        const form = document.getElementById('checkout-form-final');

        // Calculăm suma folosind funcția globală din componente.js
        const cart = window.getCart ? window.getCart() : [];
        const total = cart.reduce((acc, item) => acc + (item.pret * item.cantitate), 0);

        if (sumar) {
            sumar.innerHTML = `<h3>Total de plată: ${total.toFixed(2)} RON</h3><p>Produse: ${cart.length}</p>`;
        }

        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (cart.length === 0) {
                    alert("Coșul este gol!");
                    return;
                }

                const btn = e.target.querySelector('button');
                btn.disabled = true;
                btn.innerText = "Se procesează...";

                const payload = {
                    client_nume: document.getElementById('c-nume').value,
                    client_email: document.getElementById('c-email').value,
                    client_telefon: document.getElementById('c-telefon').value,
                    client_adresa: document.getElementById('c-adresa').value,
                    produse: cart,
                    total_plata: total
                };

                try {
                    const { error } = await window.supaClient
                        .from('comenzi')
                        .insert([payload]);

                    if (error) throw error;

                    alert("Comanda a fost trimisă cu succes!");
                    localStorage.removeItem('cart');
                    window.location.href = '../index.html';
                } catch (err) {
                    alert("Eroare: " + err.message);
                    btn.disabled = false;
                    btn.innerText = "Trimite Comanda";
                }
            });
        }
    });
</script>
</body>
</html>